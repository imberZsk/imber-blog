import ImageModal from '@/components/ImageModal'
import '../mdx.css'

> React Diff 算法详解

## 什么是 Diff 算法

Diff 算法是 React 用来比较新旧虚拟 DOM 树，找出需要更新的部分，然后只更新这些部分，而不是重新渲染整个 DOM 树。这样可以大大提高性能。

## Diff 算法的基本原则

1. **同级比较**：React 只会对同一层级的节点进行比较
2. **类型不同则重建**：如果节点类型不同，React 会直接重建整个子树
3. **key 属性**：使用 key 属性来标识节点，帮助 React 识别哪些节点是相同的

## Diff 算法的具体实现

### 1. 节点类型不同

```jsx
// 旧节点
<div>
  <Counter />
</div>

// 新节点
<span>
  <Counter />
</span>
```

在这种情况下，React 会直接删除整个 div 及其子节点，然后创建新的 span 节点。

### 2. 节点类型相同

```jsx
// 旧节点
<div className="before" title="stuff" />

// 新节点
<div className="after" title="stuff" />
```

React 会保留 DOM 节点，只更新变化的属性。

### 3. 列表渲染

```jsx
// 旧节点
<ul>
  <li key="a">A</li>
  <li key="b">B</li>
  <li key="c">C</li>
</ul>

// 新节点
<ul>
  <li key="a">A</li>
  <li key="c">C</li>
  <li key="b">B</li>
</ul>
```

使用 key 属性，React 可以识别出哪些节点是相同的，只需要移动节点位置，而不是重建。

## 优化建议

1. **使用稳定的 key**：不要使用数组索引作为 key，应该使用唯一且稳定的标识符
2. **避免频繁的节点类型变化**：保持节点类型稳定，避免不必要的重建
3. **合理使用 shouldComponentUpdate**：在必要时使用 shouldComponentUpdate 来避免不必要的渲染

## 源码分析

React 的 Diff 算法主要在 `reconcileChildren` 函数中实现：

```js
function reconcileChildren(
  current: Fiber | null,
  workInProgress: Fiber,
  nextChildren: any,
  renderLanes: Lanes
) {
  if (current === null) {
    // 首次渲染
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes
    )
  } else {
    // 更新
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes
    )
  }
}
```

## 总结

React 的 Diff 算法通过以下方式优化性能：

1. 只比较同级节点
2. 使用 key 属性识别节点
3. 只更新必要的部分
4. 避免不必要的 DOM 操作

## 源码仓库

https://github.com/facebook/react
